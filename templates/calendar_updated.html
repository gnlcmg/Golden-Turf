<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Golden Turf Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
    <style>
        /* Task indicators */
        .task-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #2563eb;
            border-radius: 50%;
        }
        
        .task-indicator.multiple {
            background: #dc2626;
        }
        
        /* Task preview */
        .task-preview {
            font-size: 0.7rem;
            margin-top: 5px;
            padding: 2px 4px;
            background: #dbeafe;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .task-preview:hover {
            background: #93c5fd;
        }
        
        /* Hover add button */
        .add-task-hover {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: green;
            color: black;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .calendar-cell:hover .add-task-hover {
            display: flex;
        }
        
        /* Task detail modal */
        .task-detail-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        
        .task-detail-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .task-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        /* Daily view task items */
        .daily-task-item {
            background: #dbeafe;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .daily-task-item.all-day {
            background: #dcfce7;
        }
        
        /* Task box on calendar day */
        .calendar-task-box {
            border: 2px solid black;
            border-radius: 5px;
            padding: 2px 5px;
            margin: 2px 0;
            cursor: pointer;
            color: black;
            font-size: 1.1rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-task-box .task-text-inner {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            font-size: 1.2rem;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .calendar-task-box.not-completed {
            background-color: #f87171; /* red */
        }
        .calendar-task-box.in-progress {
            background-color: #fbbf24; /* orange */
        }
        .calendar-task-box.completed {
            background-color: #34d399; /* green */
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="sidebar" style="position: fixed; top: 0; left: 0; width: 200px; height: 100%; background-color: #006400; color: white;">
            <div style="width:100%;text-align:center;margin-bottom:20px;">
                <img src="/static/golden_turf_logo.png" alt="Golden Turf Logo" style="width:100px;display:block;margin:0 auto;">
            </div>
            <h2 style="color: orange;">Golden Turf</h2>
            <nav class="navbar">
                <a href="{{ url_for('dashboard') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Dashboard</a>
                <div class="nav-dropdown">
                    <a href="#" class="dropbtn" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Products</a>
                    <div class="dropdown-content">
                        <a href="{{ url_for('products_list') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Products List</a>
                        <a href="{{ url_for('invoice') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Invoice Form</a>
                        <a href="{{ url_for('clients') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Client Details Form</a>
                    </div>
                </div>
                <a href="{{ url_for('quotes') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Quotes</a>
                <a href="{{ url_for('payments') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Clients &amp; Invoices List</a>
                <a href="{{ url_for('calendar') }}" style="color: white; font-size: 16px; text-decoration: none; display: block; padding: 10px;">Calendar</a>
            </nav>
        </div>

        <div class="calendar-container">
            <div class="header">
                <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="Golden Turf Logo">
                <div class="search-bar">
                    <input type="text" placeholder="Search">
                </div>
            </div>

            <div class="calendar-header">
                <a href="{{ url_for('calendar', view=view, year=prev_year, month=prev_month, day=prev_day) }}"><</a>
                {{ current_month_name }} {{ current_year }}
                <a href="{{ url_for('calendar', view=view, year=next_year, month=next_month, day=next_day) }}">></a>
            </div>

            <div class="calendar-controls">
                <a href="{{ url_for('calendar', view='month', year=current_year, month=current_month, day=current_day) }}" {% if view == 'month' %}class="active"{% endif %}>Month</a>
                <a href="{{ url_for('calendar', view='week', year=current_year, month=current_month, day=current_day) }}" {% if view == 'week' %}class="active"{% endif %}>Week</a>
                <a href="{{ url_for('calendar', view='day', year=current_year, month=current_month, day=current_day) }}" {% if view == 'day' %}class="active"{% endif %}>Day</a>
                
                <!-- Time Format Toggle -->
                <div class="time-format-toggle">
                    <button id="timeFormatToggle" class="toggle-btn" onclick="toggleTimeFormat()">
                        24h
                    </button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                {% if view == 'day' %}
                    <!-- Daily view - single large cell -->
                    <div class="calendar-cell day-view">
                        <span class="day-number">{{ current_day }}</span>
                        <!-- Time slots for daily view with tasks -->
                        <div class="time-slots">
                            {% for hour in range(0, 24) %}
                                <div class="time-slot">
                                    <span class="time-label">{{ "%02d:00"|format(hour) }}</span>
                                    <div class="time-content" id="time-{{ hour }}"></div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <!-- Week and Month views -->
                    <div class="calendar-day-header">MON</div>
                    <div class="calendar-day-header">TUE</div>
                    <div class="calendar-day-header">WED</div>
                    <div class="calendar-day-header">THU</div>
                    <div class="calendar-day-header">FRI</div>
                    <div class="calendar-day-header">SAT</div>
                    <div class="calendar-day-header">SUN</div>

                    {% if view == 'week' %}
                        {% for day in calendar_weeks[0] %}
                            <div class="calendar-cell{% if day == 0 %} inactive{% endif %}" 
                                 onmouseover="showAddButton(this)" 
                                 onmouseout="hideAddButton(this)">
                                <span class="day-number">{{ day if day != 0 else '' }}</span>
                                <div class="add-task-hover" onclick="openAddTaskModalForDate('{{ current_year }}', '{{ current_month }}', '{{ day }}')">+</div>
                                <div id="tasks-{{ day }}"></div>
                            </div>
                        {% endfor %}
                    {% else %}
                        {% for week in calendar_weeks %}
                            {% for day in week %}
                                <div class="calendar-cell{% if day == 0 %} inactive{% endif %}" 
                                     onmouseover="showAddButton(this)" 
                                     onmouseout="hideAddButton(this)">
                                    <span class="day-number">{{ day if day != 0 else '' }}</span>
                                    <div class="add-task-hover" onclick="openAddTaskModalForDate('{{ current_year }}', '{{ current_month }}', '{{ day }}')">+</div>
                                    <div id="tasks-{{ day }}"></div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Tasks Sidebar -->
        <div class="tasks-sidebar">
            <div class="tasks-header">
                <h3>Tasks</h3>
                <button class="add-task-btn" onclick="openAddTaskModal()">Add Tasks</button>
            </div>
            
    <div class="tasks-list" id="tasksList">
        <!-- Tasks will be populated by JavaScript -->
    </div>
    <script>
        // Function to render tasks in the task list
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = ''; // Clear existing tasks

            allTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-date">${formatDate(task.date)}${task.time ? ', ' + formatTime(task.time) : ''}</div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                `;
                tasksList.appendChild(taskItem);
            });
        }
    </script>

    <script>
        // New function to render tasks with status, dots, and color preview
        function renderTasksWithStatus() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = ''; // Clear existing tasks

            allTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';

                // Determine status class for color coding
                let statusClass = '';
                if (task.status === 'Completed') {
                    statusClass = 'task-completed';
                } else if (task.status.toLowerCase() === 'in progress') {
                    statusClass = 'task-in-progress';
                } else {
                    statusClass = 'task-not-completed';
                }

                taskItem.innerHTML = `
                    <div class="status-circle ${statusClass}" title="${task.status}"></div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-date">${formatDate(task.date)}${task.time ? ', ' + formatTime(task.time) : ''}</div>
                        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                    </div>
                    <div class="task-dots" title="Options">&#8942;</div>
                `;
                tasksList.appendChild(taskItem);
            });
        }

        // Call the new render function instead of the old one
        renderTasksWithStatus();

        // Function to render tasks on calendar days with color-coded boxes and three dots
        function renderTasksOnCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;

            // Clear existing tasks from calendar day cells and daily time slots
            allTasks.forEach(task => {
                const taskDate = new Date(task.date);
                const day = taskDate.getDate();

                // Clear task containers for week/month views
                const taskContainer = document.getElementById(`tasks-${day}`);
                if (taskContainer) {
                    taskContainer.innerHTML = '';
                }

                // Clear daily view time slots
                if (task.time) {
                    const hour = parseInt(task.time.split(':')[0]);
                    const timeContainer = document.getElementById(`time-${hour}`);
                    if (timeContainer) {
                        timeContainer.innerHTML = '';
                    }
                }
            });

            const currentView = '{{ view }}';
            const currentYear = {{ current_year }};
            const currentMonth = {{ current_month }} - 1; // JS months 0-based
            const currentDay = {{ current_day }};

            if (currentView === 'day') {
                // Render tasks in daily view time slots
                allTasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    const currentDate = new Date(currentYear, currentMonth, currentDay);
                    if (taskDate.toDateString() === currentDate.toDateString()) {
                        const hour = task.time ? parseInt(task.time.split(':')[0]) : null;
                        if (hour !== null) {
                            const timeContainer = document.getElementById(`time-${hour}`);
                            if (timeContainer) {
                                let statusClass = '';
                                if (task.status === 'Completed') {
                                    statusClass = 'completed';
                                } else if (task.status.toLowerCase() === 'in progress') {
                                    statusClass = 'in-progress';
                                } else {
                                    statusClass = 'not-completed';
                                }

                                const taskBox = document.createElement('div');
                                taskBox.className = `calendar-task-box ${statusClass}`;

                                const innerBox = document.createElement('div');
                                innerBox.className = 'task-text-inner';
                                innerBox.textContent = task.title;

                                taskBox.appendChild(innerBox);

                                taskBox.title = `Status: ${task.status}\nDate: ${task.date}\nTime: ${task.time || 'N/A'}\nDescription: ${task.description || 'N/A'}`;

                                taskBox.addEventListener('click', () => {
                                    openTaskDetailModal(task);
                                });

                                const dots = document.createElement('span');
                                dots.className = 'task-dots';
                                dots.innerHTML = '&#8942;';
                                dots.title = 'Options';

                                dots.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    // TODO: Implement options menu (edit, print, delete)
                                    alert('Options menu not implemented yet.');
                                });

                                taskBox.appendChild(dots);
                                timeContainer.appendChild(taskBox);
                            }
                        }
                    }
                });
            } else {
                // Render tasks in week and month views
                allTasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    const day = taskDate.getDate();
                    const taskContainer = document.getElementById(`tasks-${day}`);
                    if (taskContainer) {
                        let statusClass = '';
                        if (task.status === 'Completed') {
                            statusClass = 'completed';
                        } else if (task.status.toLowerCase() === 'in progress') {
                            statusClass = 'in-progress';
                        } else {
                            statusClass = 'not-completed';
                        }

                        const taskBox = document.createElement('div');
                        taskBox.className = `calendar-task-box ${statusClass}`;

                        const innerBox = document.createElement('div');
                        innerBox.className = 'task-text-inner';
                        innerBox.textContent = task.title;

                        taskBox.appendChild(innerBox);

                        taskBox.title = `Status: ${task.status}\nDate: ${task.date}\nTime: ${task.time || 'N/A'}\nDescription: ${task.description || 'N/A'}`;

                        taskBox.addEventListener('click', () => {
                            openTaskDetailModal(task);
                        });

                        const dots = document.createElement('span');
                        dots.className = 'task-dots';
                        dots.innerHTML = '&#8942;';
                        dots.title = 'Options';

                        dots.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // TODO: Implement options menu (edit, print, delete)
                            alert('Options menu not implemented yet.');
                        });

                        taskBox.appendChild(dots);
                        taskContainer.appendChild(taskBox);
                    }
                });
            }
        }
=======
        // Function to render tasks on calendar days with colored boxes and outline
        function renderTasksOnCalendar() {
            // Clear existing tasks on calendar
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;

            // Clear all task containers for each day and hour (for daily view)
            allTasks.forEach(task => {
                const day = new Date(task.date).getDate();
                const taskContainer = document.getElementById(`tasks-${day}`);
                if (taskContainer) {
                    taskContainer.innerHTML = '';
                }
                // Clear daily view time slots
                if (task.time) {
                    const hour = parseInt(task.time.split(':')[0]);
                    const timeContainer = document.getElementById(`time-${hour}`);
                    if (timeContainer) {
                        timeContainer.innerHTML = '';
                    }
                }
            });

            // Get current view from template variable
            const currentView = '{{ view }}';

            if (currentView === 'day') {
                // Render tasks in daily view time slots
                allTasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    const currentDate = new Date({{ current_year }}, {{ current_month }} - 1, {{ current_day }});
                    if (taskDate.toDateString() === currentDate.toDateString()) {
                        const hour = task.time ? parseInt(task.time.split(':')[0]) : null;
                        if (hour !== null) {
                            const timeContainer = document.getElementById(`time-${hour}`);
                            if (timeContainer) {
                                // Determine status class for color coding
                                let statusClass = '';
                                if (task.status === 'Completed') {
                                    statusClass = 'completed';
                                } else if (task.status.toLowerCase() === 'in progress') {
                                    statusClass = 'in-progress';
                                } else {
                                    statusClass = 'not-completed';
                                }

                                const taskBox = document.createElement('div');
                                taskBox.className = `calendar-task-box ${statusClass}`;

                                // Wrap task title in inner box for styling
                                const innerBox = document.createElement('div');
                                innerBox.className = 'task-text-inner';
                                innerBox.textContent = task.title;

                                taskBox.appendChild(innerBox);

                                taskBox.title = `Status: ${task.status}\nDate: ${task.date}\nTime: ${task.time || 'N/A'}\nDescription: ${task.description || 'N/A'}`;

                                // Add click event to open task detail modal
                                taskBox.addEventListener('click', () => {
                                    openTaskDetailModal(task);
                                });

                                // Add three dots for options inside the task box
                                const dots = document.createElement('span');
                                dots.className = 'task-dots';
                                dots.innerHTML = '&#8942;';
                                dots.title = 'Options';

                                // Prevent click on dots from opening the modal
                                dots.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    // TODO: Implement options menu (edit, print, delete)
                                    alert('Options menu not implemented yet.');
                                });

                                taskBox.appendChild(dots);
                                timeContainer.appendChild(taskBox);
                            }
                        } else {
                            // Handle all-day tasks (no time) - could add to a special container if needed
                        }
                    }
                });
            } else {
                // Render tasks in week and month views
                allTasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    const day = taskDate.getDate();
                    const taskContainer = document.getElementById(`tasks-${day}`);
                    if (taskContainer) {
                        // Determine status class for color coding
                        let statusClass = '';
                        if (task.status === 'Completed') {
                            statusClass = 'completed';
                        } else if (task.status.toLowerCase() === 'in progress') {
                            statusClass = 'in-progress';
                        } else {
                            statusClass = 'not-completed';
                        }

                        const taskBox = document.createElement('div');
                        taskBox.className = `calendar-task-box ${statusClass}`;

                        // Wrap task title in inner box for styling
                        const innerBox = document.createElement('div');
                        innerBox.className = 'task-text-inner';
                        innerBox.textContent = task.title;

                        taskBox.appendChild(innerBox);

                        taskBox.title = `Status: ${task.status}\nDate: ${task.date}\nTime: ${task.time || 'N/A'}\nDescription: ${task.description || 'N/A'}`;

                        // Add click event to open task detail modal
                        taskBox.addEventListener('click', () => {
                            openTaskDetailModal(task);
                        });

                        // Add three dots for options inside the task box
                        const dots = document.createElement('span');
                        dots.className = 'task-dots';
                        dots.innerHTML = '&#8942;';
                        dots.title = 'Options';

                        // Prevent click on dots from opening the modal
                        dots.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // TODO: Implement options menu (edit, print, delete)
                            alert('Options menu not implemented yet.');
                        });

                        taskBox.appendChild(dots);
                        taskContainer.appendChild(taskBox);
                    }
                });
            }
        }

        // Function to open task detail modal with task info
        function openTaskDetailModal(task) {
            const modal = document.getElementById('taskDetailModal');
            document.getElementById('detailTaskTitle').textContent = task.title;
            document.getElementById('detailTaskDate').textContent = task.date;
            document.getElementById('detailTaskTime').textContent = task.time || 'N/A';
            document.getElementById('detailTaskDescription').textContent = task.description || 'N/A';
            document.getElementById('detailTaskLocation').textContent = task.location || 'N/A';

            // Show modal
            modal.style.display = 'flex';

            // Disable editing fields initially
            // (Assuming modal fields are spans, so no editing by default)
        }

        // Function to close task detail modal
        function closeTaskDetailModal() {
            const modal = document.getElementById('taskDetailModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside content
        window.onclick = function(event) {
            const modal = document.getElementById('taskDetailModal');
            if (event.target === modal) {
                closeTaskDetailModal();
            }
        }

        // Call renderTasksOnCalendar after tasks are loaded
        renderTasksOnCalendar();
    </script>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddTaskModal()">&times;</span>
            <h3>Add New Task</h3>
            <form id="addTaskForm">
                <div class="form-group">
                    <label for="taskTitle">Task Title:</label>
                    <input type="text" id="taskTitle" name="taskTitle" required>
                </div>
                <div class="form-group">
                    <label for="taskDate">Date:</label>
                    <input type="date" id="taskDate" name="taskDate" required>
                </div>
                <div class="form-group">
                    <label for="taskTime">Time:</label>
                    <input type="time" id="taskTime" name="taskTime">
                </div>
                <div class="form-group">
                    <label for="taskDescription">Description:</label>
                    <textarea id="taskDescription" name="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskLocation">Location (optional):</label>
                    <input type="text" id="taskLocation" name="taskLocation" placeholder="Enter location">
                </div>
                <div class="form-group">
                    <label for="taskStatus">Status:</label>
                    <select id="taskStatus" name="taskStatus" required>
                        <option value="Not completed">Not completed</option>
                        <option value="In progress">In progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <button type="submit" class="add-task-btn">Add Task</button>
            </form>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="task-detail-modal">
        <div class="task-detail-content">
            <span class="modal-close" onclick="closeTaskDetailModal()">&times;</span>
            <h3 id="detailTaskTitle">Task Details</h3>
            <div class="task-info">
                <p><strong>Date:</strong> <span id="detailTaskDate"></span></p>
                <p><strong>Time:</strong> <span id="detailTaskTime"></span></p>
                <p><strong>Description:</strong> <span id="detailTaskDescription"></span></p>
                <p><strong>Location:</strong> <span id="detailTaskLocation"></span></p>
                <p>
