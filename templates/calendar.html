<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Golden Turf Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
    <style>
        /* Task indicators */
        .task-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #2563eb;
            border-radius: 50%;
        }
        
        .task-indicator.multiple {
            background: #dc2626;
        }
        
        /* Task preview */
        .task-preview {
            font-size: 0.7rem;
            margin-top: 5px;
            padding: 2px 4px;
            background: #dbeafe;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .task-preview:hover {
            background: #93c5fd;
        }
        
        /* Hover add button */
        .add-task-hover {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: green;
            color: black;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .calendar-cell:hover .add-task-hover {
            display: flex;
        }
        
        /* Task detail modal */
        .task-detail-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        
        .task-detail-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .task-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        /* Daily view task items */
        .daily-task-item {
            background: #dbeafe;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .daily-task-item.all-day {
            background: #dcfce7;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="sidebar">
            <h2>Golden Turf</h2>
            <nav>
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                <div class="nav-dropdown">
                    <a href="#" class="dropbtn">Products</a>
                    <div class="dropdown-content">
                        <a href="{{ url_for('products_list') }}">Products List</a>
                        <a href="{{ url_for('clients') }}">Clients & Invoices List</a>
                        <a href="{{ url_for('invoice') }}">Invoice Form</a>
                        <a href="{{ url_for('clients') }}">Client Details Form</a>
                    </div>
                </div>
                <a href="{{ url_for('calendar') }}">Calendar</a>
                <a href="{{ url_for('quotes') }}">Quotes</a>
                <a href="{{ url_for('payments') }}">Payments</a>
            </nav>
        </div>

        <div class="calendar-container">
            <div class="header">
                <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="Golden Turf Logo">
                <div class="search-bar">
                    <input type="text" placeholder="Search">
                </div>
            </div>

            <div class="calendar-header">
                <a href="{{ url_for('calendar', view=view, year=prev_year, month=prev_month, day=prev_day) }}"><</a>
                {{ current_month_name }} {{ current_year }}
                <a href="{{ url_for('calendar', view=view, year=next_year, month=next_month, day=next_day) }}">></a>
            </div>

            <div class="calendar-controls">
                <a href="{{ url_for('calendar', view='month', year=current_year, month=current_month, day=current_day) }}" {% if view == 'month' %}class="active"{% endif %}>Month</a>
                <a href="{{ url_for('calendar', view='week', year=current_year, month=current_month, day=current_day) }}" {% if view == 'week' %}class="active"{% endif %}>Week</a>
                <a href="{{ url_for('calendar', view='day', year=current_year, month=current_month, day=current_day) }}" {% if view == 'day' %}class="active"{% endif %}>Day</a>
                
                <!-- Time Format Toggle -->
                <div class="time-format-toggle">
                    <button id="timeFormatToggle" class="toggle-btn" onclick="toggleTimeFormat()">
                        24h
                    </button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                {% if view == 'day' %}
                    <!-- Daily view - single large cell -->
                    <div class="calendar-cell day-view">
                        <span class="day-number">{{ current_day }}</span>
                        <!-- Time slots for daily view with tasks -->
                        <div class="time-slots">
                            {% for hour in range(0, 24) %}
                                <div class="time-slot">
                                    <span class="time-label">{{ "%02d:00"|format(hour) }}</span>
                                    <div class="time-content" id="time-{{ hour }}"></div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <!-- Week and Month views -->
                    <div class="calendar-day-header">MON</div>
                    <div class="calendar-day-header">TUE</div>
                    <div class="calendar-day-header">WED</div>
                    <div class="calendar-day-header">THU</div>
                    <div class="calendar-day-header">FRI</div>
                    <div class="calendar-day-header">SAT</div>
                    <div class="calendar-day-header">SUN</div>

                    {% if view == 'week' %}
                        {% for day in calendar_weeks[0] %}
                            <div class="calendar-cell{% if day == 0 %} inactive{% endif %}" 
                                 onmouseover="showAddButton(this)" 
                                 onmouseout="hideAddButton(this)">
                                <span class="day-number">{{ day if day != 0 else '' }}</span>
                                <div class="add-task-hover" onclick="openAddTaskModalForDate('{{ current_year }}', '{{ current_month }}', '{{ day }}')">+</div>
                                <div id="tasks-{{ day }}"></div>
                            </div>
                        {% endfor %}
                    {% else %}
                        {% for week in calendar_weeks %}
                            {% for day in week %}
                                <div class="calendar-cell{% if day == 0 %} inactive{% endif %}" 
                                     onmouseover="showAddButton(this)" 
                                     onmouseout="hideAddButton(this)">
                                    <span class="day-number">{{ day if day != 0 else '' }}</span>
                                    <div class="add-task-hover" onclick="openAddTaskModalForDate('{{ current_year }}', '{{ current_month }}', '{{ day }}')">+</div>
                                    <div id="tasks-{{ day }}"></div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="sidebar">
            <h2>Golden Turf</h2>
            <nav>
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                <div class="nav-dropdown">
                    <a href="#" class="dropbtn">Products</a>
                    <div class="dropdown-content">
                        <a href="{{ url_for('products_list') }}">Products List</a>
                        <a href="{{ url_for('clients') }}">Clients & Invoices List</a>
                        <a href="{{ url_for('invoice') }}">Invoice Form</a>
                        <a href="{{ url_for('clients') }}">Client Details Form</a>
                    </div>
                </div>
                <a href="{{ url_for('calendar') }}">Calendar</a>
                <a href="{{ url_for('quotes') }}">Quotes</a>
                <a href="{{ url_for('payments') }}">Payments</a>
            </nav>
        </div>

        <!-- Tasks Sidebar -->
        <div class="tasks-sidebar">
            <div class="tasks-header">
                <h3>Tasks</h3>
                <button class="add-task-btn" onclick="openAddTaskModal()">Add Tasks</button>
            </div>
            
    <div class="tasks-list" id="tasksList">
        <!-- Tasks will be populated by JavaScript -->
    </div>
    <script>
        // Function to render tasks in the task list
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = ''; // Clear existing tasks

            allTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-date">${formatDate(task.date)}${task.time ? ', ' + formatTime(task.time) : ''}</div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                `;
                tasksList.appendChild(taskItem);
            });
        }
    </script>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddTaskModal()">&times;</span>
            <h3>Add New Task</h3>
            <form id="addTaskForm">
                <div class="form-group">
                    <label for="taskTitle">Task Title:</label>
                    <input type="text" id="taskTitle" name="taskTitle" required>
                </div>
                <div class="form-group">
                    <label for="taskDate">Date:</label>
                    <input type="date" id="taskDate" name="taskDate" required>
                </div>
                <div class="form-group">
                    <label for="taskTime">Time:</label>
                    <input type="time" id="taskTime" name="taskTime">
                </div>
                <div class="form-group">
                    <label for="taskDescription">Description:</label>
                    <textarea id="taskDescription" name="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskLocation">Location (optional):</label>
                    <input type="text" id="taskLocation" name="taskLocation" placeholder="Enter location">
                </div>
                <div class="form-group">
                    <label for="taskStatus">Status:</label>
                    <select id="taskStatus" name="taskStatus" required>
                        <option value="Not completed">Not completed</option>
                        <option value="In progress">In progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <button type="submit" class="add-task-btn">Add Task</button>
            </form>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="task-detail-modal">
        <div class="task-detail-content">
            <span class="modal-close" onclick="closeTaskDetailModal()">&times;</span>
            <h3 id="detailTaskTitle">Task Details</h3>
            <div class="task-info">
                <p><strong>Date:</strong> <span id="detailTaskDate"></span></p>
                <p><strong>Time:</strong> <span id="detailTaskTime"></span></p>
                <p><strong>Description:</strong> <span id="detailTaskDescription"></span></p>
                <p><strong>Location:</strong> <span id="detailTaskLocation"></span></p>
                <p><strong>Status:</strong> <span id="detailTaskStatus"></span></p>
            </div>
            <div class="task-detail-actions">
                <button class="edit-task-btn" onclick="editCurrentTask()">Edit</button>
                <button class="delete-task-btn" onclick="deleteCurrentTask()">Delete</button>
                <button class="add-task-btn" onclick="closeTaskDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Store current view information from server
        const currentYear = parseInt('{{ current_year }}', 10);
        const currentMonth = parseInt('{{ current_month }}', 10);
        
        // Global tasks array (will be populated from database)
        let allTasks = [];

        let editingTaskId = null;

        let currentPage = 1;
        const tasksPerPage = 5;

        // Fetch tasks from database
        async function fetchTasks() {
            try {
                const response = await fetch('/api/tasks');
                if (response.ok) {
                    allTasks = await response.json();
                    renderTasks();
                    renderPagination();
                    renderTasksOnCalendar();
                } else {
                    console.error('Failed to fetch tasks:', response.status);
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
        }

        // Add new task to database
        async function addTaskToDatabase(taskData) {
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.id;
                } else {
                    console.error('Failed to add task:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error adding task:', error);
                return null;
            }
        }

        // Update task in database
        async function updateTaskInDatabase(taskId, taskData) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                return response.ok;
            } catch (error) {
                console.error('Error updating task:', error);
                return false;
            }
        }

        // Delete task from database
        async function deleteTaskFromDatabase(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                return response.ok;
            } catch (error) {
                console.error('Error deleting task:', error);
                return false;
            }
        }

        // Initialize tasks
        function initializeTasks() {
            fetchTasks();
        }

        // Render tasks for current page
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            const startIndex = (currentPage - 1) * tasksPerPage;
            const endIndex = startIndex + tasksPerPage;
            const currentTasks = allTasks.slice(startIndex, endIndex);
            
            currentTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.setAttribute('data-task-id', task.id);
                taskItem.innerHTML = `
                    <div class="task-title" onclick="showTaskDetails(${task.id})">${task.title}</div>
                    <div class="task-date">${formatDate(task.date)}${task.time ? ', ' + formatTime(task.time) : ''}</div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                `;
                tasksList.appendChild(taskItem);
            });
        }

        // Render pagination
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(allTasks.length / tasksPerPage);
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.textContent = '←';
                prevBtn.onclick = () => goToPage(currentPage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // Page numbers
            const maxVisiblePages = 3;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pagination.appendChild(pageBtn);
            }
            
            // Ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'pagination-btn';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.onclick = () => goToPage(totalPages);
                pagination.appendChild(lastPageBtn);
            }
            
            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.textContent = '→';
                nextBtn.onclick = () => goToPage(currentPage + 1);
                pagination.appendChild(nextBtn);
            }
        }

        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            renderTasks();
            renderPagination();
        }

        // Function to get ordinal suffix
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th'; // Catch 11th-13th
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const day = date.getDate();
            const suffix = getOrdinalSuffix(day); // Get the ordinal suffix

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return formattedDate + suffix;
            }
        }

        // Format time based on the current format setting
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            if (is24HourFormat) {
                return `${hour < 10 ? '0' : ''}${hour}:${minutes}`; // Return 24-hour format
            } else {
                const period = hour >= 12 ? 'PM' : 'AM';
                const formattedHour = hour % 12 || 12; // Convert to 12-hour format
                return `${formattedHour}:${minutes} ${period}`;
            }
        }

        // Render tasks on calendar
        function renderTasksOnCalendar() {
            // Clear existing task indicators
            document.querySelectorAll('.task-indicator, .task-preview, .daily-task-block').forEach(el => el.remove());
            
            allTasks.forEach(task => {
                const taskDate = new Date(task.date);
                const day = taskDate.getDate();
                const month = taskDate.getMonth() + 1;
                const year = taskDate.getFullYear();
                
                // Check if this task is in the current view
                if (year === currentYear && month === currentMonth) {
                    // Find the day cell by checking day numbers
                    const dayCells = document.querySelectorAll('.calendar-cell:not(.inactive)');
                    let targetCell = null;
                    
                    dayCells.forEach(cell => {
                        const dayNumber = cell.querySelector('.day-number');
                        if (dayNumber && dayNumber.textContent.trim() == day) {
                            targetCell = cell;
                        }
                    });
                    
                    if (targetCell) {
                        // Add task indicator
                        const indicator = document.createElement('div');
                        indicator.className = 'task-indicator';
                        indicator.setAttribute('data-task-id', task.id);
                        indicator.onclick = function() { showTaskDetails(task.id); };
                        targetCell.appendChild(indicator);
                        
                        // Add task preview
                        const preview = document.createElement('div');
                        preview.className = 'task-preview';
                        preview.setAttribute('data-task-id', task.id);
                        preview.innerHTML = task.title;
                        preview.onclick = function() { showTaskDetails(task.id); };
                        targetCell.appendChild(preview);
                    }
                }
            });
            
            // Render tasks in daily view
            renderDailyViewTasks();
        }
        
        // Render tasks in daily view
        function renderDailyViewTasks() {
            // Clear existing daily view tasks
            document.querySelectorAll('.daily-task-block').forEach(el => el.remove());
            
            // Group tasks by hour for the current day
            const tasksByHour = {};
            
            allTasks.forEach(task => {
                const taskDate = new Date(task.date);
                const day = taskDate.getDate();
                const month = taskDate.getMonth() + 1;
                const year = taskDate.getFullYear();
                
                // Check if this task is for the current day in daily view
                if (year === currentYear && month === currentMonth && day === parseInt('{{ current_day }}')) {
                    let hour = 0; // Default to midnight for all-day tasks
                    
                    if (task.time) {
                        const [taskHour] = task.time.split(':');
                        hour = parseInt(taskHour);
                    }
                    
                    if (!tasksByHour[hour]) {
                        tasksByHour[hour] = [];
                    }
                    
                    tasksByHour[hour].push(task);
                }
            });
            
            // Render tasks in their respective time slots
            Object.entries(tasksByHour).forEach(([hour, tasks]) => {
                const timeContent = document.getElementById(`time-${hour}`);
                if (timeContent) {
                    // Clear existing content
                    timeContent.innerHTML = '';
                    
                    // Create container for task blocks
                    const tasksContainer = document.createElement('div');
                    tasksContainer.className = 'daily-tasks-container';
                    tasksContainer.style.display = 'flex';
                    tasksContainer.style.gap = '2px';
                    tasksContainer.style.height = '100%';
                    
                    // Create task blocks
                    tasks.forEach((task, index) => {
                        const taskBlock = document.createElement('div');
                        taskBlock.className = 'daily-task-block';
                        taskBlock.setAttribute('data-task-id', task.id);
                        taskBlock.innerHTML = task.title;
                        taskBlock.title = `${task.title}${task.time ? ' at ' + formatTime(task.time) : ''}`;
                        
                        // Style the task block
                        taskBlock.style.flex = `1 0 ${100 / tasks.length}%`;
                        taskBlock.style.background = '#dbeafe';
                        taskBlock.style.padding = '2px 4px';
                        taskBlock.style.borderRadius = '3px';
                        taskBlock.style.fontSize = '0.7rem';
                        taskBlock.style.cursor = 'pointer';
                        taskBlock.style.overflow = 'hidden';
                        taskBlock.style.textOverflow = 'ellipsis';
                        taskBlock.style.whiteSpace = 'nowrap';
                        taskBlock.style.border = '1px solid #93c5fd';
                        
                        // Add click handler
                        taskBlock.onclick = function() { showTaskDetails(task.id); };
                        
                        tasksContainer.appendChild(taskBlock);
                    });
                    
                    timeContent.appendChild(tasksContainer);
                }
            });
        }
        
        // Open add task modal with pre-filled date from parameters
        function openAddTaskModalForDate(year, month, day) {
            // Format the date as YYYY-MM-DD
            const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            document.getElementById('taskDate').value = formattedDate;
            openAddTaskModal();
        }
        
        // Show task details
        function showTaskDetails(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('detailTaskTitle').textContent = task.title;
                document.getElementById('detailTaskDate').textContent = formatDate(task.date);
                document.getElementById('detailTaskTime').textContent = task.time ? formatTime(task.time) : 'All day';
                document.getElementById('detailTaskDescription').textContent = task.description || 'No description';
                document.getElementById('detailTaskLocation').textContent = task.location || 'No location specified';
                document.getElementById('detailTaskStatus').textContent = task.status || 'Not completed';
                
                // Store current task ID for editing
                editingTaskId = taskId;
                
                // Show task detail modal
                document.getElementById('taskDetailModal').style.display = 'flex';
            }
        }
        
        // Close task detail modal
        function closeTaskDetailModal() {
            document.getElementById('taskDetailModal').style.display = 'none';
            editingTaskId = null;
        }
        
        // Edit current task
        function editCurrentTask() {
            if (editingTaskId) {
                const task = allTasks.find(t => t.id === editingTaskId);
                if (task) {
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDate').value = task.date;
                    document.getElementById('taskTime').value = task.time || '';
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskLocation').value = task.location || '';
                    document.getElementById('taskStatus').value = task.status || 'Not completed';
                    
                    closeTaskDetailModal();
                    openAddTaskModal();
                }
            }
        }
        
        // Delete current task
        async function deleteCurrentTask() {
            if (editingTaskId && confirm('Are you sure you want to delete this task?')) {
                const success = await deleteTaskFromDatabase(editingTaskId);
                if (success) {
                    // Refresh tasks from database
                    await fetchTasks();
                    closeTaskDetailModal();
                }
            }
        }

        // Modal functions
        function openAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'flex';
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
            document.getElementById('addTaskForm').reset();
        }

        // Handle form submission
        document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const date = document.getElementById('taskDate').value;
            const time = document.getElementById('taskTime').value;
            const description = document.getElementById('taskDescription').value;
            const location = document.getElementById('taskLocation').value;
            
            const status = document.getElementById('taskStatus').value;
            const taskData = {
                title: title,
                date: date,
                time: time,
                description: description,
                location: location,
                status: status
            };
            
            if (editingTaskId) {
                // Update existing task in database
                const success = await updateTaskInDatabase(editingTaskId, taskData);
                if (success) {
                    // Refresh tasks from database
                    await fetchTasks();
                    editingTaskId = null;
                }
            } else {
                // Add new task to database
                const newTaskId = await addTaskToDatabase(taskData);
                if (newTaskId) {
                    // Refresh tasks from database
                    await fetchTasks();
                }
            }
            
            closeAddTaskModal();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addTaskModal');
            if (event.target === modal) {
                closeAddTaskModal();
            }
        };

        // Function to toggle task details for a specific day
        function toggleTaskDetails(day) {
            const taskDetails = document.getElementById(`taskDetails-${day}`);
            if (taskDetails.style.display === 'none') {
                taskDetails.style.display = 'block';
                populateTasksForDay(day);
            } else {
                taskDetails.style.display = 'none';
            }
        }

        // Populate tasks for a specific day
        function populateTasksForDay(day) {
            const tasksForDay = document.getElementById(`tasksForDay-${day}`);
            tasksForDay.innerHTML = ''; // Clear existing tasks
            
            const tasks = allTasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.getDate() === parseInt(day);
            });
            
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-date">${formatDate(task.date)}${task.time ? ', ' + formatTime(task.time) : ''}</div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                `;
                tasksForDay.appendChild(taskItem);
            });
        }

        // Edit task function
        function editTask(day) {
            const tasks = allTasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.getDate() === parseInt(day);
            });
            
            if (tasks.length > 0) {
                const task = tasks[0]; // Edit first task for simplicity
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDate').value = task.date;
                document.getElementById('taskTime').value = task.time || '';
                document.getElementById('taskDescription').value = task.description || '';
                editingTaskId = task.id;
                openAddTaskModal();
            }
        }

        // Delete task function
        async function deleteTask(day) {
            const tasks = allTasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.getDate() === parseInt(day);
            });
            
            if (tasks.length > 0 && confirm('Are you sure you want to delete this task?')) {
                const success = await deleteTaskFromDatabase(tasks[0].id);
                if (success) {
                    // Refresh tasks from database
                    await fetchTasks();
                    // Close the task details
                    document.getElementById(`taskDetails-${day}`).style.display = 'none';
                }
            }
        }

        // Time format variable
        let is24HourFormat = true; // Default to 24-hour format

        // Toggle time format
        function toggleTimeFormat() {
            is24HourFormat = !is24HourFormat; // Toggle the format
            const toggleButton = document.getElementById('timeFormatToggle');
            toggleButton.textContent = is24HourFormat ? '24h' : '12h'; // Update button text
            renderTasksOnCalendar(); // Re-render tasks to apply the new format
        }
        
        // Format time
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            if (is24HourFormat) {
                return `${hour < 10 ? '0' : ''}${hour}:${minutes}`; // Return 24-hour format
            } else {
                const period = hour >= 12 ? 'PM' : 'AM';
                const formattedHour = hour % 12 || 12; // Convert to 12-hour format
                return `${formattedHour}:${minutes} ${period}`;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeTasks);
    </script>

    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 0.5rem 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination-btn.active {
            background: green;
            color: black;
            border-color: green;
        }

        .pagination-btn:hover:not(.active) {
            background: #f1f5f9;
        }

        .pagination-ellipsis {
            padding: 0.5rem;
        }

        .task-description {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.3rem;
        }
    </style>
</body>
</html>
