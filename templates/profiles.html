<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>User Profiles - Golden Turf</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='invoice.css') }}" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
            .container {
                margin-left: 240px;
                padding: 20px 40px;
                max-width: calc(100vw - 260px);
            }
            .password-container {
                position: relative;
                display: flex;
                align-items: center;
            }
            .password-container input {
                flex: 1;
                padding-right: 40px;
            }
            .password-container .toggle-password {
                position: absolute;
                right: 10px;
                cursor: pointer;
                color: #666;
                font-size: 16px;
                z-index: 10;
            }
            .password-container .toggle-password:hover {
                color: #333;
            }
                .permission-label {
                    color: #0074d9;
                    font-weight: 500;
                    margin-left: 4px;
                }
        </style>
    </head>
    <body>

        <div class="container">
            <header>
                <h1>User Profiles</h1>
            </header>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="{{ 'error' if category == 'error' else 'success' }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if session['user_role'] == 'admin' or session['user_id'] == 1 %}
            <form method="POST" action="{{ url_for('profiles') }}">
                <section class="user-form">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required />

                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required />

                    <label for="password">Password:</label>
                    <div class="password-container">
                        <input type="password" id="password" name="password" required />
                        <i class="fa fa-eye toggle-password" id="togglePassword" title="Show/Hide Password"></i>
                    </div>

                    <button type="submit">Add User</button>
                </section>
            </form>
            <script>
                const togglePassword = document.querySelector('#togglePassword');
                const passwordInput = document.querySelector('#password');
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.classList.toggle('fa-eye-slash');
                });
            </script>
            {% endif %}

            <section class="user-list">
                <h2>Existing Users</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user[0] }}</td>
                            <td>{{ user[1] }}</td>
                            <td>{{ user[2] }}</td>
                            <td>{{ user[3] }}</td>
                            <td>
                                {% if session['user_role'] == 'admin' or session['user_id'] == 1 %}
                                <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; min-width: 120px;">
                                    <form action="{{ url_for('toggle_admin', user_id=user[0]) }}" method="post" style="width:100%;">
                                        {% set is_only_admin = only_admin_id is not none and user[0] == only_admin_id %}
                                        {% if is_only_admin %}
                                            {% set admin_btn_style = 'width:100%; padding:6px 0; background:#ccc; color:#fff; border:none; border-radius:4px; font-size:14px; margin-bottom:4px; cursor:not-allowed;' %}
                                        {% elif user[3] == 'admin' %}
                                            {% set admin_btn_style = 'width:100%; padding:6px 0; background:#ff9800; color:#fff; border:none; border-radius:4px; font-size:14px; margin-bottom:4px; cursor:pointer;' %}
                                        {% else %}
                                            {% set admin_btn_style = 'width:100%; padding:6px 0; background:#0074d9; color:#fff; border:none; border-radius:4px; font-size:14px; margin-bottom:4px; cursor:pointer;' %}
                                        {% endif %}
                                        <button type="submit"
                                            title="Toggle Admin Role"
                                            style="{{ admin_btn_style }}"
                                            {% if is_only_admin %}disabled{% endif %}>
                                            {% if user[3] == 'admin' %}
                                                Revoke Admin
                                            {% else %}
                                                Make Admin
                                            {% endif %}
                                        </button>
                                        {% if is_only_admin %}
                                            <span style="font-size:11px;color:#888;">At least one admin required.</span>
                                        {% endif %}
                                    </form>
                                    <form action="{{ url_for('delete_user', user_id=user[0]) }}" method="post" style="width:100%;">
                                        <button type="submit" style="width:100%; padding: 6px 0; background:#dc3545; color:#fff; border:none; border-radius:4px; font-size:14px; margin-bottom: 4px;">Delete</button>
                                    </form>
                                    <a href="{{ url_for('edit_user', user_id=user[0]) }}" style="display:block; width:100%; padding:6px 0; background:#28a745; color:#fff; border:none; border-radius:4px; text-decoration:none; font-size:14px; text-align:center;">Edit</a>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        </div>

        {% include '_sidebar.html' %}
    </body>
</html>
