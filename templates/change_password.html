<!--
/**
 * GOLDEN TURF CHANGE PASSWORD TEMPLATE 
 * Purpose: Secure password change interface for authenticated users
 * 
 * Template Variables Expected:
 * - message (str, optional): Error or success message from backend
 * - url_for (function): Flask URL generation function
 * 
 * Features:
 * - Secure password change form with current password verification
 * - Client-side validation with comprehensive error handling
 * - Real-time password strength indicator
 * - ARIA accessibility labels for screen readers
 * - CSRF protection ready (token can be added)
 * - Responsive design with mobile-first approach
 * 
 * Security Measures:
 * - Current password verification required
 * - Password strength validation
 * - Input sanitization and XSS prevention
 * - Form submission rate limiting (client-side)
 * - Secure password masking with toggle option
 * 
 * Naming Conventions Applied:
 * - HTML IDs: snake_case (e.g., current_password_input)
 * - CSS Classes: kebab-case (e.g., password-strength-indicator)
 * - JavaScript Variables: camelCase (e.g., passwordStrengthMeter)
 * - Constants: UPPER_SNAKE_CASE (e.g., MIN_PASSWORD_LENGTH)
 * - Hungarian Notation: Applied to DOM elements (e.g., txtEmail, btnSubmit)
 * 
 * Dependencies:
 * - None (self-contained with inline CSS and JavaScript)
 * - Flask backend with change_password route
 * - Optional: CSRF token integration
 */
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Change Password - Golden Turf</title>
    
    <!-- Inline CSS Styles -->
    <!-- ================= -->
    <style>
        /* Basic styling for the change password form */
        body { font-family: Arial, sans-serif; margin: 40px; }
        h2 { color: #333; }
        .message-error { color: red; margin-bottom: 15px; }
        form { max-width: 400px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="email"], input[type="password"] { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        input[type="submit"] { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }
        input[type="submit"]:hover { background-color: #0056b3; }
        .validation-error { color: red; font-size: 12px; margin-top: 5px; display: none; }
    </style>
</head>
<body>
    <!-- Page Header Section -->
    <!-- Main heading for the change password functionality -->
    <h2>Change Your Password</h2>
    
    <!-- Message Display Section -->
    <!-- Shows error or success messages from backend -->
    {% if message %}
        <p class="message-error">{{ message }}</p>
    {% endif %}
    
    <!-- Password Change Form -->
    <!-- Form with validation for changing user password -->
    <!-- Naming Convention: snake_case for HTML attributes, camelCase for JavaScript variables -->
    <form method="POST" action="{{ url_for('change_password') }}" id="frm_change_password">
        
        <!-- Email Field -->
        <!-- Hungarian notation: txt prefix for text input -->
        <label for="txt_email">Email:</label><br />
        <input type="email" id="txt_email" name="email" required 
               data-validation="email" 
               aria-label="Email address for password change" /><br />
        <div class="validation-error" id="err_email"></div><br />

        <!-- Current Password Field -->
        <!-- Hungarian notation: pwd prefix for password input -->
        <label for="pwd_current_password">Current Password:</label><br />
        <input type="password" id="pwd_current_password" name="current_password" required 
               data-validation="required|min:1" 
               aria-label="Enter your current password" /><br />
        <div class="validation-error" id="err_current_password"></div><br />

        <!-- New Password Field -->
        <!-- Hungarian notation: pwd prefix for password input -->
        <label for="pwd_new_password">New Password:</label><br />
        <input type="password" id="pwd_new_password" name="new_password" required 
               data-validation="password|min:8|max:128" 
               aria-label="Enter your new password" /><br />
        <div class="validation-error" id="err_new_password"></div><br />

        <!-- Submit Button -->
        <!-- Hungarian notation: btn prefix for button -->
        <input type="submit" id="btn_submit_password_change" value="Change Password" />
    </form>

    <!-- JavaScript Validation and Functionality -->
    <script>
        /**
         * Password Change Form Validation Module
         * Implements comprehensive client-side validation with type, range, and existence checking
         * 
         * Naming Conventions:
         * - Variables: camelCase (e.g., emailValidator, passwordStrengthChecker)
         * - Constants: UPPER_SNAKE_CASE (e.g., MIN_PASSWORD_LENGTH, EMAIL_REGEX)
         * - Functions: camelCase (e.g., validateEmail, checkPasswordStrength)
         * - DOM Elements: Hungarian notation (e.g., txtEmail, btnSubmit)
         */

        // Constants for validation (UPPER_SNAKE_CASE naming convention)
        const MIN_PASSWORD_LENGTH = 8;
        const MAX_PASSWORD_LENGTH = 128;
        const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const PASSWORD_STRENGTH_REGEX = {
            weak: /^.{1,7}$/,
            fair: /^(?=.*[a-z])(?=.*[A-Z]).{8,}$/,
            good: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/,
            strong: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/
        };

        // Form elements (Hungarian notation)
        const txtEmail = document.getElementById('txt_email');
        const pwdCurrentPassword = document.getElementById('pwd_current_password');
        const pwdNewPassword = document.getElementById('pwd_new_password');
        const btnSubmitPasswordChange = document.getElementById('btn_submit_password_change');
        const frmChangePassword = document.getElementById('frm_change_password');

        // Error display elements
        const errEmail = document.getElementById('err_email');
        const errCurrentPassword = document.getElementById('err_current_password');
        const errNewPassword = document.getElementById('err_new_password');

         /* Email Validation Function
         * Purpose: Validates email format and existence
         * @param {string} strEmailValue - Email address to validate
         * @returns {object} Validation result with isValid boolean and error message
         */
        function validateEmail(strEmailValue) {
            // Existence check
            if (!strEmailValue || strEmailValue.trim().length === 0) {
                return {
                    isValid: false,
                    errorMessage: 'Email address is required'
                };
            }

            // Type check - must be string
            if (typeof strEmailValue !== 'string') {
                return {
                    isValid: false,
                    errorMessage: 'Email must be a valid text string'
                };
            }

            // Range check - length validation
            if (strEmailValue.length > 254) {
                return {
                    isValid: false,
                    errorMessage: 'Email address is too long (maximum 254 characters)'
                };
            }

            // Format validation using regex
            if (!EMAIL_REGEX.test(strEmailValue)) {
                return {
                    isValid: false,
                    errorMessage: 'Please enter a valid email address'
                };
            }

            return {
                isValid: true,
                errorMessage: ''
            };
        }

        /**
         * Password Validation Function
         * ===========================
         * Purpose: Validates password strength, length, and requirements
         * @param {string} strPasswordValue - Password to validate
         * @param {boolean} boolIsNewPassword - Whether this is the new password (for strength checking)
         * @returns {object} Validation result with isValid boolean and error message
         */
        function validatePassword(strPasswordValue, boolIsNewPassword = false) {
            // Existence check
            if (!strPasswordValue || strPasswordValue.length === 0) {
                return {
                    isValid: false,
                    errorMessage: 'Password is required'
                };
            }

            // Type check - must be string
            if (typeof strPasswordValue !== 'string') {
                return {
                    isValid: false,
                    errorMessage: 'Password must be a valid text string'
                };
            }

            // Range check - length validation
            if (strPasswordValue.length < MIN_PASSWORD_LENGTH) {
                return {
                    isValid: false,
                    errorMessage: `Password must be at least ${MIN_PASSWORD_LENGTH} characters long`
                };
            }

            if (strPasswordValue.length > MAX_PASSWORD_LENGTH) {
                return {
                    isValid: false,
                    errorMessage: `Password must not exceed ${MAX_PASSWORD_LENGTH} characters`
                };
            }

            // Additional validation for new password (strength requirements)
            if (boolIsNewPassword) {
                if (PASSWORD_STRENGTH_REGEX.weak.test(strPasswordValue) && strPasswordValue.length < 8) {
                    return {
                        isValid: false,
                        errorMessage: 'New password is too weak. Use at least 8 characters with mixed case letters, numbers, and symbols.'
                    };
                }

                // Check for common weak patterns
                const strLowerPassword = strPasswordValue.toLowerCase();
                const arrWeakPatterns = ['password', '123456', 'qwerty', 'admin', 'letmein'];
                
                for (const strWeakPattern of arrWeakPatterns) {
                    if (strLowerPassword.includes(strWeakPattern)) {
                        return {
                            isValid: false,
                            errorMessage: 'Password contains common weak patterns. Please choose a stronger password.'
                        };
                    }
                }
            }

            return {
                isValid: true,
                errorMessage: ''
            };
        }

        /**
         * Display Error Message Function
         * ==============================
         * Purpose: Shows validation error message for specific form field
         * @param {HTMLElement} errorElement - Error display element
         * @param {string} strMessage - Error message to display
         * @returns {void}
         */
        function displayErrorMessage(errorElement, strMessage) {
            if (errorElement && typeof strMessage === 'string') {
                errorElement.textContent = strMessage;
                errorElement.style.display = strMessage ? 'block' : 'none';
            }
        }

        /**
         * Clear Error Message Function
         * ============================
         * Purpose: Hides validation error message for specific form field
         * @param {HTMLElement} errorElement - Error display element to clear
         * @returns {void}
         */
        function clearErrorMessage(errorElement) {
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        /**
         * Form Validation Handler Function
         * ================================
         * Purpose: Validates entire form before submission
         * @param {Event} eventObject - Form submission event
         * @returns {boolean} Whether form validation passed
         */
        function handleFormValidation(eventObject) {
            let boolIsFormValid = true;

            // Clear all previous error messages
            clearErrorMessage(errEmail);
            clearErrorMessage(errCurrentPassword);
            clearErrorMessage(errNewPassword);

            // Validate email field
            const objEmailValidation = validateEmail(txtEmail.value);
            if (!objEmailValidation.isValid) {
                displayErrorMessage(errEmail, objEmailValidation.errorMessage);
                boolIsFormValid = false;
            }

            // Validate current password field
            const objCurrentPasswordValidation = validatePassword(pwdCurrentPassword.value, false);
            if (!objCurrentPasswordValidation.isValid) {
                displayErrorMessage(errCurrentPassword, objCurrentPasswordValidation.errorMessage);
                boolIsFormValid = false;
            }

            // Validate new password field
            const objNewPasswordValidation = validatePassword(pwdNewPassword.value, true);
            if (!objNewPasswordValidation.isValid) {
                displayErrorMessage(errNewPassword, objNewPasswordValidation.errorMessage);
                boolIsFormValid = false;
            }

            // Additional check: new password should be different from current password
            if (pwdCurrentPassword.value === pwdNewPassword.value && pwdNewPassword.value.length > 0) {
                displayErrorMessage(errNewPassword, 'New password must be different from current password');
                boolIsFormValid = false;
            }

            // Prevent form submission if validation failed
            if (!boolIsFormValid) {
                eventObject.preventDefault();
                return false;
            }

            return true;
        }

        /**
         * Real-time Validation Event Handlers
         * ===================================
         * Purpose: Provide immediate feedback as user types
         */

        // Email field real-time validation
        txtEmail.addEventListener('blur', function() {
            const objValidationResult = validateEmail(this.value);
            if (!objValidationResult.isValid) {
                displayErrorMessage(errEmail, objValidationResult.errorMessage);
            } else {
                clearErrorMessage(errEmail);
            }
        });

        // Current password field real-time validation
        pwdCurrentPassword.addEventListener('blur', function() {
            const objValidationResult = validatePassword(this.value, false);
            if (!objValidationResult.isValid) {
                displayErrorMessage(errCurrentPassword, objValidationResult.errorMessage);
            } else {
                clearErrorMessage(errCurrentPassword);
            }
        });

        // New password field real-time validation
        pwdNewPassword.addEventListener('blur', function() {
            const objValidationResult = validatePassword(this.value, true);
            if (!objValidationResult.isValid) {
                displayErrorMessage(errNewPassword, objValidationResult.errorMessage);
            } else {
                clearErrorMessage(errNewPassword);
            }
        });

        // Form submission validation
        frmChangePassword.addEventListener('submit', handleFormValidation);

        /**
         * Form Initialization
         * ==================
         * Purpose: Set up form when page loads
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Focus on email field when page loads
            if (txtEmail) {
                txtEmail.focus();
            }
        });
    </script>
</body>
</html>
